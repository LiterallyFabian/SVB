<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<nav class="navigation" id="topnav">
    <ul>
        <a href="/"><div id="logo" class="navlogo" alt="LOGO"></div></a>

        <li><a href="/" class="active">Nyheter</a></li>
        <li><a href=#pagewrap>Lokalt</a></li>
        <li><a href=/members>Medlemmar</a></li>
        <li><a href="/catch">svt!catch</a></li>
        <li><a href="/kontakt.html">Kontakt</a></li>
        <li><a v-bind:href="href" v-if="!loggedIn">Logga in</a></li>
        <li><a href="/post" v-if="canPost">Skapa inl√§gg</a></li>
        <li><a v-bind:href="profilehref" v-if="loggedIn">{{ username }}</a></li>
        <a href="javascript:void(0);" class="icon" onclick="toggleNav()">
            <i class="fa fa-bars"></i>
</nav>

<script>
    function toggleNav() {
        var x = document.getElementById("topnav");
        if (x.className === "navigation") {
            x.className += " responsive";
        } else {
            x.className = "navigation";
        }
    }

    const Login = {
        data() {
            return {
                username: "",
                href: "https://discord.com/api/oauth2/authorize?client_id=793179363029549057&redirect_uri=https%3A%2F%2Fsvt.sajber.me%2Fauth&response_type=code&scope=identify",
                profilehref: "",
                loggedIn: false,
                canPost: false
            }

        },
        mounted: function trylogin() {
            this.$nextTick(function () {
                this.usercookie = getCookie("auth")
                if (this.usercookie.length > 0) {
                    var data = JSON.parse(this.usercookie);
                    this.access_token = data.access_token;
                    this.id = data.id;
                    this.vue_autologin();
                } else {
                    console.log("No access token found, can not log in automatically.")
                }
            })
        },

        methods: {
            async vue_autologin() {
                console.log("Tries to login from saved access token...");
                await axios.post("/auth/verify", {
                    access_token: this.access_token,
                    id: this.id,
                    auth: getAuth()
                }).then(res => {
                    if (res.data[0].name != null) {
                        this.profilehref = "/profile?user=" + res.data[0].id;
                        this.loggedIn = true;
                        this.username = res.data[0].name + "#" + res.data[0].discriminator;
                        this.canPost = res.data[0].canPost;
                    }
                })
            },
        }
    }

    Vue.createApp(Login).mount('.navigation')
</script>